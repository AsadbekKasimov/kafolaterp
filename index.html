<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ERP System v2</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Onest:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary-red: #DC2626; --red-hover: #B91C1C; --red-light: #FEE2E2; --red-dark: #991B1B;
            --bg-white: #FFFFFF; --bg-gray: #F9FAFB; --text-dark: #111827; --text-gray: #6B7280;
            --border-gray: #E5E7EB; --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1); --green: #059669; --green-light: #D1FAE5;
        }
        body { font-family: 'Onest', -apple-system, sans-serif; background: var(--bg-gray); color: var(--text-dark); line-height: 1.6; overscroll-behavior: contain; -webkit-overflow-scrolling: touch; }
        .app-container { max-width: 1400px; margin: 0 auto; min-height: 100vh; display: flex; flex-direction: column; }
        .header { background: var(--bg-white); border-bottom: 1px solid var(--border-gray); padding: 1rem 1.5rem; position: sticky; top: 0; z-index: 100; box-shadow: var(--shadow); }
        .header-content { display: flex; justify-content: space-between; align-items: center; }
        .logo { display: flex; align-items: center; gap: 0.75rem; font-size: 1.5rem; font-weight: 800; }
        .logo-icon { width: 36px; height: 36px; background: linear-gradient(135deg, var(--primary-red), var(--red-dark)); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; }
        .lang-switcher { display: flex; gap: 0.25rem; background: var(--bg-gray); padding: 0.25rem; border-radius: 8px; }
        .lang-btn { padding: 0.375rem 0.75rem; border: none; background: transparent; color: var(--text-gray); cursor: pointer; border-radius: 6px; font-weight: 500; transition: all 0.2s; font-size: 0.875rem; }
        .lang-btn.active { background: var(--bg-white); color: var(--primary-red); box-shadow: var(--shadow); }
        .nav-tabs { display: flex; gap: 0.5rem; padding: 1rem 1.5rem 0; background: var(--bg-white); border-bottom: 1px solid var(--border-gray); overflow-x: auto; }
        .nav-tab { padding: 0.75rem 1rem; border: none; background: transparent; color: var(--text-gray); cursor: pointer; border-bottom: 2px solid transparent; font-weight: 600; transition: all 0.2s; white-space: nowrap; font-size: 0.875rem; }
        .nav-tab.active { color: var(--primary-red); border-bottom-color: var(--primary-red); }
        .content { flex: 1; padding: 2rem 1.5rem; }
        .card { background: var(--bg-white); border-radius: 12px; padding: 1.5rem; box-shadow: var(--shadow); border: 1px solid var(--border-gray); margin-bottom: 1.5rem; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .card-title { font-size: 1.25rem; font-weight: 700; }
        .form-group { margin-bottom: 1.25rem; }
        .form-label { display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.875rem; }
        .form-input, .form-select { width: 100%; padding: 0.75rem 1rem; border: 1px solid var(--border-gray); border-radius: 8px; font-size: 1rem; font-family: 'Onest', sans-serif; transition: all 0.2s; }
        .form-input:focus, .form-select:focus { outline: none; border-color: var(--primary-red); box-shadow: 0 0 0 3px var(--red-light); }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
        .btn { padding: 0.75rem 1.5rem; border: none; border-radius: 8px; font-weight: 600; font-size: 1rem; cursor: pointer; transition: all 0.2s; font-family: 'Onest', sans-serif; display: inline-flex; align-items: center; gap: 0.5rem; }
        .btn-primary { background: var(--primary-red); color: white; }
        .btn-primary:hover { background: var(--red-hover); transform: translateY(-1px); }
        .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .btn-secondary { background: var(--bg-gray); color: var(--text-dark); border: 1px solid var(--border-gray); }
        .btn-secondary:hover { background: var(--border-gray); }
        .btn-success { background: var(--green); color: white; }
        .btn-success:hover { background: #047857; }
        .btn-sm { padding: 0.5rem 1rem; font-size: 0.875rem; }
        .btn-group { display: flex; gap: 0.75rem; flex-wrap: wrap; }
        .table-container { overflow-x: auto; border-radius: 8px; border: 1px solid var(--border-gray); margin-top: 1rem; }
        .table { width: 100%; border-collapse: collapse; background: var(--bg-white); }
        .table th { background: var(--bg-gray); padding: 0.875rem; text-align: left; font-weight: 700; color: var(--text-dark); border-bottom: 2px solid var(--border-gray); font-size: 0.8125rem; text-transform: uppercase; letter-spacing: 0.05em; }
        .table td { padding: 0.875rem; border-bottom: 1px solid var(--border-gray); }
        .table tbody tr:hover { background: var(--bg-gray); }
        .table-actions { display: flex; gap: 0.5rem; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .stat-card { background: var(--bg-white); border-radius: 12px; padding: 1.5rem; box-shadow: var(--shadow); border: 1px solid var(--border-gray); transition: all 0.2s; }
        .stat-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); }
        .stat-icon { width: 48px; height: 48px; border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-bottom: 1rem; font-size: 1.5rem; background: var(--red-light); color: var(--primary-red); }
        .stat-label { font-size: 0.875rem; color: var(--text-gray); font-weight: 600; margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.05em; }
        .stat-value { font-size: 2rem; font-weight: 800; }
        .success-message, .error-message { padding: 1rem; border-radius: 8px; margin-bottom: 1rem; font-weight: 600; animation: slideDown 0.3s ease-out; }
        .success-message { background: var(--green-light); color: #065F46; }
        .error-message { background: var(--red-light); color: var(--red-dark); }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .loading { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 4rem 2rem; }
        .spinner { width: 48px; height: 48px; border: 4px solid var(--border-gray); border-top-color: var(--primary-red); border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 1rem; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .empty-state { text-align: center; padding: 3rem 2rem; color: var(--text-gray); }
        .empty-icon { font-size: 3rem; margin-bottom: 1rem; opacity: 0.3; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 1000; align-items: center; justify-content: center; padding: 1rem; }
        .modal.show { display: flex; }
        .modal-content { background: var(--bg-white); border-radius: 12px; padding: 2rem; max-width: 500px; width: 100%; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .modal-title { font-size: 1.5rem; font-weight: 700; }
        .modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-gray); width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 6px; transition: all 0.2s; }
        .modal-close:hover { background: var(--bg-gray); }
        .report-summary { background: var(--bg-gray); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem; }
        .report-row { display: flex; justify-content: space-between; margin-bottom: 0.75rem; font-size: 1rem; }
        .report-row.total { font-size: 1.25rem; font-weight: 700; padding-top: 0.75rem; border-top: 2px solid var(--border-gray); }
        .report-label { color: var(--text-gray); }
        .report-value { font-weight: 600; color: var(--text-dark); }
        .report-value.positive { color: var(--green); }
        .report-value.negative { color: var(--primary-red); }
        .reconciliation-table td { text-align: right; }
        .reconciliation-table td:first-child { text-align: left; }
        .reconciliation-table td:nth-child(2) { text-align: center; }
        .balance-row { font-weight: 700; background: #FFF9E6 !important; }
        .debug-info { background: #FFF3CD; border: 1px solid #FFECB5; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; font-size: 0.875rem; }
        @media (max-width: 768px) {
            .header { padding: 1rem; }
            .content { padding: 1.5rem 1rem; }
            .form-row { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: 1fr; }
            .nav-tabs { padding: 1rem 1rem 0; }
            .table-actions { flex-direction: column; }
        }
        @media print {
            .header, .nav-tabs, .btn, .debug-info { display: none; }
            .content { padding: 0; }
        }
    </style>
</head>
<body>
    <div id="app" class="app-container"></div>
    <div id="modalContainer"></div>
    
    <script>

        let USER_ROLE = null;
        let CLIENT_ID = null;
        
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxCbyemOx7BitMAS12pYPeloDiPJOIOyBOT1riFOVEATNckcXRnqIeGb7A4MbvXDX9msA/exec'';
        const isConfigured = SCRIPT_URL !== 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE' && SCRIPT_URL.includes('script.google.com');
        
        const T = {
            ru: {
                appTitle: 'ERP –°–∏—Å—Ç–µ–º–∞',
                dashboard: '–ü–∞–Ω–µ–ª—å',
                sales: '–û—Ç–≥—Ä—É–∑–∫–∏',
                receipts: '–û–ø–ª–∞—Ç—ã',
                clients: '–ö–ª–∏–µ–Ω—Ç—ã',
                products: '–¢–æ–≤–∞—Ä—ã',
                prices: '–¶–µ–Ω—ã',
                report: '–ê–∫—Ç —Å–≤–µ—Ä–∫–∏',
                addSale: '–î–æ–±–∞–≤–∏—Ç—å –æ—Ç–≥—Ä—É–∑–∫—É',
                addReceipt: '–î–æ–±–∞–≤–∏—Ç—å –æ–ø–ª–∞—Ç—É',
                addClient: '–î–æ–±–∞–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞',
                addProduct: '–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä',
                setPrice: '–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ü–µ–Ω—É',
                client: '–ö–ª–∏–µ–Ω—Ç',
                product: '–¢–æ–≤–∞—Ä',
                quantity: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ',
                amount: '–°—É–º–º–∞',
                price: '–¶–µ–Ω–∞',
                date: '–î–∞—Ç–∞',
                save: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å',
                cancel: '–û—Ç–º–µ–Ω–∏—Ç—å',
                edit: '–ò–∑–º–µ–Ω–∏—Ç—å',
                delete: '–£–¥–∞–ª–∏—Ç—å',
                name: '–ù–∞–∑–≤–∞–Ω–∏–µ',
                phone: '–¢–µ–ª–µ—Ñ–æ–Ω',
                address: '–ê–¥—Ä–µ—Å',
                notes: '–ü—Ä–∏–º–µ—á–∞–Ω–∏—è',
                unit: '–ï–¥–∏–Ω–∏—Ü–∞',
                category: '–ö–∞—Ç–µ–≥–æ—Ä–∏—è',
                description: '–û–ø–∏—Å–∞–Ω–∏–µ',
                totalSales: '–û–±—â–∏–µ –æ—Ç–≥—Ä—É–∑–∫–∏',
                totalReceipts: '–û–±—â–∏–µ –æ–ø–ª–∞—Ç—ã',
                clientsCount: '–ö–ª–∏–µ–Ω—Ç–æ–≤',
                productsCount: '–¢–æ–≤–∞—Ä–æ–≤',
                actions: '–î–µ–π—Å—Ç–≤–∏—è',
                loading: '–ó–∞–≥—Ä—É–∑–∫–∞...',
                success: '–£—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ!',
                selectClient: '–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞',
                selectProduct: '–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä',
                noData: '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö',
                confirmDelete: '–í—ã —É–≤–µ—Ä–µ–Ω—ã?',
                enterPrice: '–í–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É',
                sum: '—Å—É–º',
                startDate: '–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞',
                endDate: '–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è',
                generate: '–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å',
                reconciliationAct: '–ê–∫—Ç —Å–≤–µ—Ä–∫–∏ –≤–∑–∞–∏–º–æ—Ä–∞—Å—á–µ—Ç–æ–≤',
                period: '–ü–µ—Ä–∏–æ–¥',
                type: '–¢–∏–ø',
                shipped: '–ü–µ—Ä–µ–¥–∞–Ω–æ',
                received: '–ü—Ä–∏–Ω—è—Ç–æ',
                balance: '–°–∞–ª—å–¥–æ',
                debt: '–ó–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å –∫–ª–∏–µ–Ω—Ç–∞',
                overpayment: '–ü–µ—Ä–µ–ø–ª–∞—Ç–∞ –∫–ª–∏–µ–Ω—Ç–∞',
                print: '–ü–µ—á–∞—Ç—å',
                paymentType: '–¢–∏–ø –æ–ø–ª–∞—Ç—ã',
                cash: '–ù–∞–ª–∏—á–Ω—ã–µ',
                card: '–ö–∞—Ä—Ç–∞',
                transfer: '–ü–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏–µ',
                bankTransfer: '–ë–µ–∑–Ω–∞–ª',
                docNumber: '–ù–æ–º–µ—Ä –¥–æ–∫—É–º–µ–Ω—Ç–∞',
                note: '–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ',
                initialBalance: '***–ù–∞—á–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å***',
                totalShipped: '–û–±—â–∏–µ –æ—Ç–≥—Ä—É–∑–∫–∏ / –û–±—â–∏–µ –æ–ø–ª–∞—Ç—ã'
            },
            uz: {
                appTitle: 'ERP Tizimi',
                dashboard: 'Boshqaruv',
                sales: 'Yetkazish',
                receipts: "To'lovlar",
                clients: 'Mijozlar',
                products: 'Mahsulotlar',
                prices: 'Narxlar',
                report: 'Sverka akti',
                addSale: "Yetkazish qo'shish",
                addReceipt: "To'lov qo'shish",
                addClient: "Mijoz qo'shish",
                addProduct: "Mahsulot qo'shish",
                setPrice: "Narx o'rnatish",
                client: 'Mijoz',
                product: 'Mahsulot',
                quantity: 'Miqdor',
                amount: 'Summa',
                price: 'Narx',
                date: 'Sana',
                save: 'Saqlash',
                cancel: 'Bekor qilish',
                edit: "O'zgartirish",
                delete: "O'chirish",
                name: 'Nomi',
                phone: 'Telefon',
                address: 'Manzil',
                notes: 'Izohlar',
                unit: "O'lchov",
                category: 'Kategoriya',
                description: 'Tavsif',
                totalSales: 'Jami yetkazish',
                totalReceipts: "Jami to'lovlar",
                clientsCount: 'Mijozlar',
                productsCount: 'Mahsulotlar',
                actions: 'Harakatlar',
                loading: 'Yuklanmoqda...',
                success: 'Saqlandi!',
                selectClient: 'Mijozni tanlang',
                selectProduct: 'Mahsulotni tanlang',
                noData: "Ma'lumot yo'q",
                confirmDelete: 'Ishonchingiz komilmi?',
                enterPrice: 'Narxni kiriting',
                sum: 'sum',
                startDate: 'Boshlanish',
                endDate: 'Tugash',
                generate: 'Yaratish',
                reconciliationAct: 'Sverka akti',
                period: 'Davr',
                type: 'Turi',
                shipped: 'Yetkazildi',
                received: 'Qabul qilindi',
                balance: 'Balans',
                debt: 'Qarz',
                overpayment: "Ortiqcha to'lov",
                print: 'Chop etish',
                paymentType: "To'lov turi",
                cash: 'Naqd',
                card: 'Karta',
                transfer: "O'tkazma",
                bankTransfer: 'Bank',
                docNumber: 'Hujjat raqami',
                note: 'Izoh',
                initialBalance: '***Boshlang\'ich balans***',
                totalShipped: "Jami yetkazish / Jami to'lovlar"
            }
        };
        
        let state = {
            lang: 'ru',
            activeTab: 'dashboard',
            loading: true,
            showSuccess: false,
            error: null,
            clients: [],
            products: [],
            clientProducts: {},
            salesData: [],
            receiptsData: []
        };
        
        function t(key) { return T[state.lang][key] || key; }
        
        async function apiCall(action, params = {}) {
            if (!isConfigured) throw new Error('URL –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω');
            const url = new URL(SCRIPT_URL);
            url.searchParams.append('action', action);
            Object.keys(params).forEach(key => {
                if (params[key] !== null && params[key] !== undefined) {
                    url.searchParams.append(key, params[key]);
                }
            });
            
            console.log('üì° API Call:', action, params);
            
            const response = await fetch(url);
            if (!response.ok) throw new Error(`–û—à–∏–±–∫–∞: ${response.status}`);
            const result = await response.json();
            
            console.log('üì• API Response:', action, result);
            
            return result;
        }
        
        async function loadClients() {
            const result = await apiCall('getClients');
            if (result.success) state.clients = result.clients || [];
        }
        
        async function loadProducts() {
            const result = await apiCall('getProducts');
            if (result.success) state.products = result.products || [];
        }
        
        async function loadClientProducts(clientId) {
            const result = await apiCall('getClientProducts', { clientId });
            if (result.success) state.clientProducts[clientId] = result.products || [];
        }
        
        async function loadSales(clientId = null, startDate = null, endDate = null) {
            const params = {};
            if (clientId) params.clientId = clientId;
            if (startDate) params.startDate = startDate;
            if (endDate) params.endDate = endDate;
            
            if (!startDate && !endDate) {
                params.startDate = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                params.endDate = new Date().toISOString().split('T')[0];
            }
            
            const result = await apiCall('getSales', params);
            if (result.success) state.salesData = result.sales || [];
        }
        
        async function loadReceipts(clientId = null, startDate = null, endDate = null) {
            const params = {};
            if (clientId) params.clientId = clientId;
            if (startDate) params.startDate = startDate;
            if (endDate) params.endDate = endDate;
            
            if (!startDate && !endDate) {
                params.startDate = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                params.endDate = new Date().toISOString().split('T')[0];
            }
            
            const result = await apiCall('getReceipts', params);
            if (result.success) state.receiptsData = result.receipts || [];
        }
        
        function renderHeader() {
            return `
                <header class="header">
                    <div class="header-content">
                        <div class="logo"><div class="logo-icon">E</div><span>${t('appTitle')}</span></div>
                        <div class="lang-switcher">
                            <button class="lang-btn ${state.lang === 'ru' ? 'active' : ''}" onclick="setLang('ru')">RU</button>
                            <button class="lang-btn ${state.lang === 'uz' ? 'active' : ''}" onclick="setLang('uz')">UZ</button>
                        </div>
                    </div>
                </header>
            `;
        }
        
        function renderNav() {

    // ===== –ö–õ–ò–ï–ù–¢ =====
    if (USER_ROLE === 'client') {
        return `
            <nav class="nav-tabs">
                <button class="nav-tab active">üìÑ –ê–∫—Ç —Å–≤–µ—Ä–∫–∏</button>
            </nav>
        `;
    }

    // ===== –ê–î–ú–ò–ù (–°–¢–ê–†–´–ô –ö–û–î) =====
    return `
        <nav class="nav-tabs">
            <button class="nav-tab ${state.activeTab === 'dashboard' ? 'active' : ''}" onclick="setTab('dashboard')">–ü–∞–Ω–µ–ª—å</button>
            <button class="nav-tab ${state.activeTab === 'report' ? 'active' : ''}" onclick="setTab('report')">–ê–∫—Ç —Å–≤–µ—Ä–∫–∏</button>
            <button class="nav-tab ${state.activeTab === 'sales' ? 'active' : ''}" onclick="setTab('sales')">–ü—Ä–æ–¥–∞–∂–∏</button>
            <button class="nav-tab ${state.activeTab === 'receipts' ? 'active' : ''}" onclick="setTab('receipts')">–ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è</button>
            <button class="nav-tab ${state.activeTab === 'clients' ? 'active' : ''}" onclick="setTab('clients')">–ö–ª–∏–µ–Ω—Ç—ã</button>
            <button class="nav-tab ${state.activeTab === 'products' ? 'active' : ''}" onclick="setTab('products')">–¢–æ–≤–∞—Ä—ã</button>
            <button class="nav-tab ${state.activeTab === 'prices' ? 'active' : ''}" onclick="setTab('prices')">–¶–µ–Ω—ã</button>
        </nav>
    `;
}

        
        function renderDashboard() {
            const totalSales = state.salesData.reduce((sum, s) => sum + (parseFloat(s.amount) || 0), 0);
            const totalReceipts = state.receiptsData.reduce((sum, r) => sum + (parseFloat(r.amount) || 0), 0);
            
            return `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">üìä</div>
                        <div class="stat-label">${t('totalSales')}</div>
                        <div class="stat-value">${totalSales.toLocaleString('ru-RU')} ${t('sum')}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üì•</div>
                        <div class="stat-label">${t('totalReceipts')}</div>
                        <div class="stat-value">${totalReceipts.toLocaleString('ru-RU')} ${t('sum')}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üë•</div>
                        <div class="stat-label">${t('clientsCount')}</div>
                        <div class="stat-value">${state.clients.length}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üì¶</div>
                        <div class="stat-label">${t('productsCount')}</div>
                        <div class="stat-value">${state.products.length}</div>
                    </div>
                </div>
            `;
        }
        
        function renderReport() {
            return `
                <div class="card">
                    <h3 class="card-title">${t('reconciliationAct')}</h3>
                    <form onsubmit="generateReport(event)">
                        <div class="form-group">
                            <label class="form-label">${t('client')}</label>
                            <select class="form-select" name="client" required>
                                <option value="">${t('selectClient')}</option>
                                ${state.clients.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">${t('startDate')}</label>
                                <input type="date" class="form-input" name="startDate" value="${new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]}" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">${t('endDate')}</label>
                                <input type="date" class="form-input" name="endDate" value="${new Date().toISOString().split('T')[0]}" required>
                            </div>
                        </div>
                        <div class="btn-group">
                            <button type="submit" class="btn btn-primary">üìä ${t('generate')}</button>
                        </div>
                    </form>
                    
                    <div id="reportResult"></div>
                </div>
            `;
        }
        
        function renderReportResult(clientName, startDate, endDate, sales, receipts) {
            console.log('üîç Rendering report:', { clientName, startDate, endDate, salesCount: sales.length, receiptsCount: receipts.length });
            console.log('üìä Sales data:', sales);
            console.log('üí∞ Receipts data:', receipts);
            
            const totalSales = sales.reduce((sum, s) => sum + (parseFloat(s.amount) || 0), 0);
            const totalReceipts = receipts.reduce((sum, r) => sum + (parseFloat(r.amount) || 0), 0);
            const balance = totalSales - totalReceipts;
            
            console.log('üíµ Totals:', { totalSales, totalReceipts, balance });
            
            // –û–±—ä–µ–¥–∏–Ω—è–µ–º –∏ —Å–æ—Ä—Ç–∏—Ä—É–µ–º –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ø–æ –¥–∞—Ç–µ
            const allOperations = [
                ...sales.map(s => ({
                    date: new Date(s.date),
                    type: s.docNumber || `–û—Ç–≥—Ä—É–∑–∫–∞ #${s.id}`,
                    details: `${s.product} (${s.quantity} ${s.price ? '√ó ' + parseFloat(s.price).toLocaleString('ru-RU', {minimumFractionDigits: 2}) : ''})`,
                    shipped: s.amount,
                    received: 0,
                    isBalance: false
                })),
                ...receipts.map(r => ({
                    date: new Date(r.date),
                    type: r.docNumber || `–û–ø–ª–∞—Ç–∞ #${r.id}`,
                    details: r.paymentType || '',
                    shipped: 0,
                    received: r.amount,
                    isBalance: false
                }))
            ].sort((a, b) => a.date - b.date);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å –≤ –Ω–∞—á–∞–ª–æ
            allOperations.unshift({
                date: new Date(startDate),
                type: t('initialBalance'),
                details: '',
                shipped: 0,
                received: 0,
                isBalance: true
            });
            
            console.log('üìã All operations:', allOperations);
            
            return `
                <div style="margin-top: 2rem;">
                    <div class="debug-info">
                        <strong>üîç –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</strong><br>
                        –ù–∞–π–¥–µ–Ω–æ –æ—Ç–≥—Ä—É–∑–æ–∫: ${sales.length}<br>
                        –ù–∞–π–¥–µ–Ω–æ –æ–ø–ª–∞—Ç: ${receipts.length}<br>
                        –°—É–º–º–∞ –æ—Ç–≥—Ä—É–∑–æ–∫: ${totalSales.toLocaleString('ru-RU', {minimumFractionDigits: 2})} —Å—É–º<br>
                        –°—É–º–º–∞ –æ–ø–ª–∞—Ç: ${totalReceipts.toLocaleString('ru-RU', {minimumFractionDigits: 2})} —Å—É–º<br>
                        –°–∞–ª—å–¥–æ: ${balance.toLocaleString('ru-RU', {minimumFractionDigits: 2})} —Å—É–º
                    </div>
                    
                    <div class="report-summary">
                        <h4 style="margin-bottom: 1rem; font-size: 1.125rem;">${t('reconciliationAct')}</h4>
                        <div class="report-row">
                            <span class="report-label">${t('client')}:</span>
                            <span class="report-value">${clientName}</span>
                        </div>
                        <div class="report-row">
                            <span class="report-label">${t('period')}:</span>
                            <span class="report-value">${new Date(startDate).toLocaleDateString('ru-RU')} - ${new Date(endDate).toLocaleDateString('ru-RU')}</span>
                        </div>
                        <div class="report-row total">
                            <span class="report-label">${t('balance')}:</span>
                            <span class="report-value ${balance > 0 ? 'negative' : balance < 0 ? 'positive' : ''}">
                                ${Math.abs(balance).toLocaleString('ru-RU', {minimumFractionDigits: 2})} ${t('sum')} 
                                ${balance > 0 ? '(' + t('debt') + ')' : balance < 0 ? '(' + t('overpayment') + ')' : ''}
                            </span>
                        </div>
                    </div>
                    
                    <h4 style="margin: 1.5rem 0 1rem; font-size: 1.125rem;">${t('reconciliationAct')}</h4>
                    <div class="table-container">
                        <table class="table reconciliation-table">
                            <thead>
                                <tr>
                                    <th>${t('type')}</th>
                                    <th>${t('date')}</th>
                                    <th>${t('shipped')}</th>
                                    <th>${t('received')}</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${allOperations.map(op => `
                                    <tr class="${op.isBalance ? 'balance-row' : ''}">
                                        <td>
                                            ${op.type}
                                            ${op.details ? `<br><small style="color: var(--text-gray);">${op.details}</small>` : ''}
                                        </td>
                                        <td style="text-align: center;">${op.date.toLocaleDateString('ru-RU')}</td>
                                        <td>${op.shipped > 0 ? parseFloat(op.shipped).toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : ''}</td>
                                        <td>${op.received > 0 ? parseFloat(op.received).toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : ''}</td>
                                    </tr>
                                `).join('')}
                                <tr style="font-weight: 700; background: var(--bg-gray);">
                                    <td colspan="2">${t('totalShipped')}</td>
                                    <td>${totalSales.toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                    <td>${totalReceipts.toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                </tr>
                                <tr class="balance-row">
                                    <td colspan="2">${t('balance')}</td>
                                    <td colspan="2">${Math.abs(balance).toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2})} ${balance > 0 ? t('debt') : balance < 0 ? t('overpayment') : ''}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="btn-group" style="margin-top: 1.5rem;">
                        <button class="btn btn-secondary" onclick="window.print()">üñ®Ô∏è ${t('print')}</button>
                    </div>
                </div>
            `;
        }
        
        async function generateReport(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const clientId = formData.get('client');
            const startDate = formData.get('startDate');
            const endDate = formData.get('endDate');
            
            console.log('üìä Generating report for:', { clientId, startDate, endDate });
            
            const client = state.clients.find(c => c.id == clientId);
            
            if (!client) {
                console.error('‚ùå Client not found:', clientId);
                return;
            }
            
            try {
                const [salesResult, receiptsResult] = await Promise.all([
                    apiCall('getSales', { clientId, startDate, endDate }),
                    apiCall('getReceipts', { clientId, startDate, endDate })
                ]);
                
                console.log('üì• Sales result:', salesResult);
                console.log('üì• Receipts result:', receiptsResult);
                
                const sales = salesResult.success ? salesResult.sales || [] : [];
                const receipts = receiptsResult.success ? receiptsResult.receipts || [] : [];
                
                console.log('‚úÖ Parsed data:', { sales, receipts });
                
                document.getElementById('reportResult').innerHTML = renderReportResult(
                    client.name, startDate, endDate, sales, receipts
                );
            } catch (error) {
                console.error('‚ùå Report generation error:', error);
                state.error = error.message;
                render();
            }
        }
        
        function renderSalesForm() {
            return `
                <div class="card">
                    <h3 class="card-title">${t('addSale')}</h3>
                    ${state.showSuccess ? `<div class="success-message">‚úì ${t('success')}</div>` : ''}
                    ${state.error ? `<div class="error-message">‚úó ${state.error}</div>` : ''}
                    <form onsubmit="handleSaleSubmit(event)">
                        <div class="form-group">
                            <label class="form-label">${t('client')}</label>
                            <select class="form-select" name="client" onchange="handleClientChange(this.value)" required>
                                <option value="">${t('selectClient')}</option>
                                ${state.clients.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">${t('product')}</label>
                            <select class="form-select" name="product" id="productSelect" onchange="handleProductChange(this.value)" required disabled>
                                <option value="">${t('selectProduct')}</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">${t('docNumber')}</label>
                                <input type="text" class="form-input" name="docNumber" placeholder="–û—Ç–≥—Ä—É–∑–∫–∞ #...">
                            </div>
                            <div class="form-group">
                                <label class="form-label">${t('date')}</label>
                                <input type="date" class="form-input" name="date" value="${new Date().toISOString().split('T')[0]}" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">${t('quantity')}</label>
                                <input type="number" class="form-input" name="quantity" id="quantityInput" onchange="calculateAmount()" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">${t('price')} (${t('sum')})</label>
                                <input type="number" class="form-input" name="price" id="priceInput" readonly required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">${t('amount')} (${t('sum')})</label>
                                <input type="number" class="form-input" name="amount" id="amountInput" readonly required>
                            </div>
                        </div>
                        <div class="btn-group">
                            <button type="submit" class="btn btn-primary">‚úì ${t('save')}</button>
                            <button type="button" class="btn btn-secondary" onclick="setTab('dashboard')">‚úï ${t('cancel')}</button>
                        </div>
                    </form>
                </div>
            `;
        }
        
        function renderReceiptsForm() {
            return `
                <div class="card">
                    <h3 class="card-title">${t('addReceipt')}</h3>
                    ${state.showSuccess ? `<div class="success-message">‚úì ${t('success')}</div>` : ''}
                    <form onsubmit="handleReceiptSubmit(event)">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">${t('client')}</label>
                                <select class="form-select" name="client" required>
                                    <option value="">${t('selectClient')}</option>
                                    ${state.clients.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">${t('paymentType')}</label>
                                <select class="form-select" name="paymentType" required>
                                    <option value="–ù–∞–ª–∏—á–Ω—ã–µ">${t('cash')}</option>
                                    <option value="–ö–∞—Ä—Ç–∞">${t('card')}</option>
                                    <option value="–ü–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏–µ">${t('transfer')}</option>
                                    <option value="–ë–µ–∑–Ω–∞–ª">${t('bankTransfer')}</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">${t('docNumber')}</label>
                                <input type="text" class="form-input" name="docNumber" placeholder="–û–ø–ª–∞—Ç–∞ –∫–ª–∏–µ–Ω—Ç–∞ #...">
                            </div>
                            <div class="form-group">
                                <label class="form-label">${t('date')}</label>
                                <input type="date" class="form-input" name="date" value="${new Date().toISOString().split('T')[0]}" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">${t('amount')} (${t('sum')})</label>
                            <input type="number" class="form-input" name="amount" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">${t('note')}</label>
                            <input type="text" class="form-input" name="note" placeholder="${t('note')}">
                        </div>
                        <div class="btn-group">
                            <button type="submit" class="btn btn-primary">‚úì ${t('save')}</button>
                            <button type="button" class="btn btn-secondary" onclick="setTab('dashboard')">‚úï ${t('cancel')}</button>
                        </div>
                    </form>
                </div>
            `;
        }
        
        function renderClients() {
            return `
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">${t('clients')}</h3>
                        <button class="btn btn-success btn-sm" onclick="showClientModal()">+ ${t('addClient')}</button>
                    </div>
                    ${state.clients.length > 0 ? `
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>${t('name')}</th>
                                        <th>${t('phone')}</th>
                                        <th>${t('address')}</th>
                                        <th>${t('actions')}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${state.clients.map(c => `
                                        <tr>
                                            <td>${c.id}</td>
                                            <td>${c.name}</td>
                                            <td>${c.phone || '-'}</td>
                                            <td>${c.address || '-'}</td>
                                            <td class="table-actions">
                                                <button class="btn btn-secondary btn-sm" onclick="editClient(${c.id})">${t('edit')}</button>
                                                <button class="btn btn-secondary btn-sm" onclick="deleteClient(${c.id})">${t('delete')}</button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    ` : `<div class="empty-state"><div class="empty-icon">üë•</div><p>${t('noData')}</p></div>`}
                </div>
            `;
        }
        
        function renderProducts() {
            return `
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">${t('products')}</h3>
                        <button class="btn btn-success btn-sm" onclick="showProductModal()">+ ${t('addProduct')}</button>
                    </div>
                    ${state.products.length > 0 ? `
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>${t('name')}</th>
                                        <th>${t('unit')}</th>
                                        <th>${t('category')}</th>
                                        <th>${t('actions')}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${state.products.map(p => `
                                        <tr>
                                            <td>${p.id}</td>
                                            <td>${p.name}</td>
                                            <td>${p.unit}</td>
                                            <td>${p.category || '-'}</td>
                                            <td class="table-actions">
                                                <button class="btn btn-secondary btn-sm" onclick="editProduct(${p.id})">${t('edit')}</button>
                                                <button class="btn btn-secondary btn-sm" onclick="deleteProduct(${p.id})">${t('delete')}</button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    ` : `<div class="empty-state"><div class="empty-icon">üì¶</div><p>${t('noData')}</p></div>`}
                </div>
            `;
        }
        
        function renderPrices() {
            return `
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">${t('prices')}</h3>
                        <button class="btn btn-success btn-sm" onclick="showPriceModal()">+ ${t('setPrice')}</button>
                    </div>
                    <div class="form-group">
                        <label class="form-label">${t('selectClient')}</label>
                        <select class="form-select" onchange="loadAndShowClientPrices(this.value)">
                            <option value="">${t('selectClient')}</option>
                            ${state.clients.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}
                        </select>
                    </div>
                    <div id="pricesTable"></div>
                </div>
            `;
        }
        
        function showClientModal(clientId = null) {
            const client = clientId ? state.clients.find(c => c.id == clientId) : null;
            const modal = `
                <div class="modal show">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title">${client ? t('edit') : t('addClient')}</h3>
                            <button class="modal-close" onclick="closeModal()">√ó</button>
                        </div>
                        <form onsubmit="saveClient(event, ${clientId})">
                            <div class="form-group">
                                <label class="form-label">${t('name')}</label>
                                <input type="text" class="form-input" name="name" value="${client ? client.name : ''}" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">${t('phone')}</label>
                                <input type="text" class="form-input" name="phone" value="${client ? client.phone : ''}">
                            </div>
                            <div class="form-group">
                                <label class="form-label">${t('address')}</label>
                                <input type="text" class="form-input" name="address" value="${client ? client.address : ''}">
                            </div>
                            <div class="form-group">
                                <label class="form-label">${t('notes')}</label>
                                <input type="text" class="form-input" name="notes" value="${client ? client.notes : ''}">
                            </div>
                            <div class="btn-group">
                                <button type="submit" class="btn btn-primary">‚úì ${t('save')}</button>
                                <button type="button" class="btn btn-secondary" onclick="closeModal()">‚úï ${t('cancel')}</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            document.getElementById('modalContainer').innerHTML = modal;
        }
        
        function showProductModal(productId = null) {
            const product = productId ? state.products.find(p => p.id == productId) : null;
            const modal = `
                <div class="modal show">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title">${product ? t('edit') : t('addProduct')}</h3>
                            <button class="modal-close" onclick="closeModal()">√ó</button>
                        </div>
                        <form onsubmit="saveProduct(event, ${productId})">
                            <div class="form-group">
                                <label class="form-label">${t('name')}</label>
                                <input type="text" class="form-input" name="name" value="${product ? product.name : ''}" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">${t('unit')}</label>
                                <input type="text" class="form-input" name="unit" value="${product ? product.unit : '—à—Ç'}" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">${t('category')}</label>
                                <input type="text" class="form-input" name="category" value="${product ? product.category : ''}">
                            </div>
                            <div class="form-group">
                                <label class="form-label">${t('description')}</label>
                                <input type="text" class="form-input" name="description" value="${product ? product.description : ''}">
                            </div>
                            <div class="btn-group">
                                <button type="submit" class="btn btn-primary">‚úì ${t('save')}</button>
                                <button type="button" class="btn btn-secondary" onclick="closeModal()">‚úï ${t('cancel')}</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            document.getElementById('modalContainer').innerHTML = modal;
        }
        
        function showPriceModal() {
            const modal = `
                <div class="modal show">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title">${t('setPrice')}</h3>
                            <button class="modal-close" onclick="closeModal()">√ó</button>
                        </div>
                        <form onsubmit="savePrice(event)">
                            <div class="form-group">
                                <label class="form-label">${t('client')}</label>
                                <select class="form-select" name="client" required>
                                    <option value="">${t('selectClient')}</option>
                                    ${state.clients.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">${t('product')}</label>
                                <select class="form-select" name="product" required>
                                    <option value="">${t('selectProduct')}</option>
                                    ${state.products.map(p => `<option value="${p.id}">${p.name}</option>`).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">${t('price')} (${t('sum')})</label>
                                <input type="number" class="form-input" name="price" placeholder="${t('enterPrice')}" required>
                            </div>
                            <div class="btn-group">
                                <button type="submit" class="btn btn-primary">‚úì ${t('save')}</button>
                                <button type="button" class="btn btn-secondary" onclick="closeModal()">‚úï ${t('cancel')}</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            document.getElementById('modalContainer').innerHTML = modal;
        }
        
        function closeModal() { document.getElementById('modalContainer').innerHTML = ''; }
        
        async function saveClient(event, clientId) {
            event.preventDefault();
            const formData = new FormData(event.target);
            try {
                const result = clientId 
                    ? await apiCall('updateClient', { id: clientId, name: formData.get('name'), phone: formData.get('phone'), address: formData.get('address'), notes: formData.get('notes') })
                    : await apiCall('addClient', { name: formData.get('name'), chatId: '', phone: formData.get('phone'), address: formData.get('address'), notes: formData.get('notes') });
                if (result.success) { closeModal(); await loadClients(); state.showSuccess = true; render(); setTimeout(() => { state.showSuccess = false; render(); }, 3000); }
            } catch (error) { state.error = error.message; render(); }
        }
        
        async function saveProduct(event, productId) {
            event.preventDefault();
            const formData = new FormData(event.target);
            try {
                const result = productId 
                    ? await apiCall('updateProduct', { id: productId, name: formData.get('name'), unit: formData.get('unit'), category: formData.get('category'), description: formData.get('description') })
                    : await apiCall('addProduct', { name: formData.get('name'), unit: formData.get('unit'), category: formData.get('category'), description: formData.get('description') });
                if (result.success) { closeModal(); await loadProducts(); state.showSuccess = true; render(); setTimeout(() => { state.showSuccess = false; render(); }, 3000); }
            } catch (error) { state.error = error.message; render(); }
        }
        
        async function savePrice(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const clientId = formData.get('client');
            const productId = formData.get('product');
            const client = state.clients.find(c => c.id == clientId);
            const product = state.products.find(p => p.id == productId);
            try {
                const result = await apiCall('setClientPrice', { clientId, clientName: client.name, productId, productName: product.name, price: formData.get('price') });
                if (result.success) { closeModal(); state.showSuccess = true; render(); setTimeout(() => { state.showSuccess = false; render(); }, 3000); }
            } catch (error) { state.error = error.message; render(); }
        }
        
        async function editClient(id) { showClientModal(id); }
        async function deleteClient(id) { if (!confirm(t('confirmDelete'))) return; try { const result = await apiCall('deleteClient', { id }); if (result.success) { await loadClients(); render(); } } catch (error) { state.error = error.message; render(); } }
        async function editProduct(id) { showProductModal(id); }
        async function deleteProduct(id) { if (!confirm(t('confirmDelete'))) return; try { const result = await apiCall('deleteProduct', { id }); if (result.success) { await loadProducts(); render(); } } catch (error) { state.error = error.message; render(); } }
        
        async function handleClientChange(clientId) {
            if (!clientId) { document.getElementById('productSelect').disabled = true; document.getElementById('productSelect').innerHTML = `<option value="">${t('selectProduct')}</option>`; return; }
            await loadClientProducts(clientId);
            const products = state.clientProducts[clientId] || [];
            const select = document.getElementById('productSelect');
            select.disabled = false;
            select.innerHTML = `<option value="">${t('selectProduct')}</option>` + products.map(p => `<option value="${p.productId}" data-price="${p.price}">${p.productName} - ${parseFloat(p.price).toLocaleString('ru-RU')} ${t('sum')}</option>`).join('');
        }
        
        function handleProductChange(productId) {
            const select = document.getElementById('productSelect');
            const option = select.options[select.selectedIndex];
            const price = option.getAttribute('data-price');
            document.getElementById('priceInput').value = price;
            calculateAmount();
        }
        
        function calculateAmount() {
            const quantity = parseFloat(document.getElementById('quantityInput').value) || 0;
            const price = parseFloat(document.getElementById('priceInput').value) || 0;
            document.getElementById('amountInput').value = quantity * price;
        }
        
        async function handleSaleSubmit(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const clientId = formData.get('client');
            const productId = formData.get('product');
            const client = state.clients.find(c => c.id == clientId);
            const product = state.products.find(p => p.id == productId);
            try {
                const result = await apiCall('addSale', { 
                    clientId, 
                    clientName: client.name, 
                    productId, 
                    productName: product.name, 
                    quantity: formData.get('quantity'), 
                    price: formData.get('price'), 
                    date: formData.get('date'),
                    docNumber: formData.get('docNumber') || null
                });
                if (result.success) { 
                    event.target.reset(); 
                    document.getElementById('productSelect').disabled = true;
                    document.getElementById('productSelect').innerHTML = `<option value="">${t('selectProduct')}</option>`;
                    document.getElementById('priceInput').value = '';
                    document.getElementById('amountInput').value = '';
                    await loadSales(); 
                    state.showSuccess = true; 
                    render(); 
                    setTimeout(() => { state.showSuccess = false; render(); }, 3000); 
                }
            } catch (error) { state.error = error.message; render(); }
        }
        
        async function handleReceiptSubmit(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const clientId = formData.get('client');
            const client = state.clients.find(c => c.id == clientId);
            try {
                const result = await apiCall('addReceipt', { 
                    clientId, 
                    clientName: client.name, 
                    paymentType: formData.get('paymentType'),
                    amount: formData.get('amount'), 
                    date: formData.get('date'),
                    docNumber: formData.get('docNumber') || null,
                    note: formData.get('note') || ''
                });
                if (result.success) { event.target.reset(); await loadReceipts(); state.showSuccess = true; render(); setTimeout(() => { state.showSuccess = false; render(); }, 3000); }
            } catch (error) { state.error = error.message; render(); }
        }
        
        async function loadAndShowClientPrices(clientId) {
            if (!clientId) { document.getElementById('pricesTable').innerHTML = ''; return; }
            await loadClientProducts(clientId);
            const products = state.clientProducts[clientId] || [];
            document.getElementById('pricesTable').innerHTML = products.length > 0 ? `
                <div class="table-container">
                    <table class="table">
                        <thead><tr><th>${t('product')}</th><th>${t('price')}</th><th>${t('actions')}</th></tr></thead>
                        <tbody>
                            ${products.map(p => `<tr><td>${p.productName}</td><td>${parseFloat(p.price).toLocaleString('ru-RU')} ${t('sum')}</td><td><button class="btn btn-secondary btn-sm" onclick="deletePrice(${clientId}, ${p.productId})">${t('delete')}</button></td></tr>`).join('')}
                        </tbody>
                    </table>
                </div>
            ` : `<div class="empty-state"><div class="empty-icon">üí∞</div><p>${t('noData')}</p></div>`;
        }
        
        async function deletePrice(clientId, productId) {
            if (!confirm(t('confirmDelete'))) return;
            try { const result = await apiCall('deleteClientPrice', { clientId, productId }); if (result.success) await loadAndShowClientPrices(clientId); } catch (error) { state.error = error.message; render(); }
        }
        
        function render() {
            const app = document.getElementById('app');
            if (!isConfigured) { app.innerHTML = `<div class="loading"><div class="spinner"></div><p>‚ö†Ô∏è URL –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω!</p></div>`; return; }
            if (state.loading) { app.innerHTML = `<div class="loading"><div class="spinner"></div><p>${t('loading')}</p></div>`; return; }
            let content = '';
            switch(state.activeTab) {
                case 'dashboard': content = renderDashboard(); break;
                case 'report': content = renderReport(); break;
                case 'sales': content = renderSalesForm(); break;
                case 'receipts': content = renderReceiptsForm(); break;
                case 'clients': content = renderClients(); break;
                case 'products': content = renderProducts(); break;
                case 'prices': content = renderPrices(); break;
            }
            app.innerHTML = `${renderHeader()}${renderNav()}<main class="content">${content}</main>`;
        }
        
        window.setLang = function(lang) { state.lang = lang; render(); }
        window.setTab = function(tab) { state.activeTab = tab; state.error = null; render(); }
        window.showClientModal = showClientModal;
        window.showProductModal = showProductModal;
        window.showPriceModal = showPriceModal;
        window.closeModal = closeModal;
        window.saveClient = saveClient;
        window.saveProduct = saveProduct;
        window.savePrice = savePrice;
        window.editClient = editClient;
        window.deleteClient = deleteClient;
        window.editProduct = editProduct;
        window.deleteProduct = deleteProduct;
        window.handleClientChange = handleClientChange;
        window.handleProductChange = handleProductChange;
        window.calculateAmount = calculateAmount;
        window.handleSaleSubmit = handleSaleSubmit;
        window.handleReceiptSubmit = handleReceiptSubmit;
        window.loadAndShowClientPrices = loadAndShowClientPrices;
        window.deletePrice = deletePrice;
        window.generateReport = generateReport;
        
        async function init() {
    state.loading = true;
    render();

    // === üîê –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø ===
    const tg = window.Telegram?.WebApp;
    const chatId = tg?.initDataUnsafe?.user?.id;

    if (!chatId) {
        showNoAccess('–û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏–∑ Telegram');
        return;
    }

    const auth = await apiCall('detectUser', { chatId });

    if (!auth.success) {
        showNoAccess('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
        return;
    }

    const user = auth.user;

    if (user.role === 'admin') {
        USER_ROLE = 'admin';
        // –∞–¥–º–∏–Ω ‚Äî –≤—Å—ë –∫–∞–∫ —Ä–∞–Ω—å—à–µ
    }
    else if (user.role === 'client') {
        USER_ROLE = 'client';
        CLIENT_ID = user.clientId;
        state.activeTab = 'report'; // —Å—Ä–∞–∑—É –∞–∫—Ç —Å–≤–µ—Ä–∫–∏
    }
    else {
        showNoAccess('–£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞. –°–≤—è–∂–∏—Ç–µ—Å—å —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.');
        return;
    }

    // === TELEGRAM READY ===
    if (tg) {
        tg.ready();
        tg.expand();
        // –û—Ç–∫–ª—é—á–∞–µ–º –∑–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ —Å–≤–∞–π–ø–µ –≤–Ω–∏–∑
        tg.isVerticalSwipesEnabled = false;
    }

    // === –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• ===
    await Promise.all([
        loadClients(),
        loadProducts(),
        loadSales(),
        loadReceipts()
    ]);

    state.loading = false;
    render();
}

        init();


        function showNoAccess(text) {
    document.getElementById('app').innerHTML = `
      <div class="card" style="max-width:480px;margin:80px auto;text-align:center">
        <h3>‚õî –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω</h3>
        <p>${text}</p>
      </div>
    `;
  }
        
    </script>
</body>
</html>
