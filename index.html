        <!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Enhanced ERP WebApp</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Onest:wght@400;500;600;700;800&display=swap" rel="stylesheet">

<style>
:root{
  --red:#dc2626;
  --red-dark:#991b1b;
  --bg:#f9fafb;
  --card:#ffffff;
  --border:#e5e7eb;
  --text:#111827;
  --muted:#6b7280;
}
*{box-sizing:border-box;margin:0;padding:0}
body{
  font-family:Onest,sans-serif;
  background:var(--bg);
  color:var(--text);
}
header{
  background:#fff;
  border-bottom:1px solid var(--border);
  padding:14px 20px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.logo{
  font-size:20px;
  font-weight:800;
  display:flex;
  gap:10px;
  align-items:center;
}
.logo span{
  background:linear-gradient(135deg,var(--red),var(--red-dark));
  color:#fff;
  padding:6px 10px;
  border-radius:8px;
}
nav{
  display:flex;
  gap:10px;
  background:#fff;
  border-bottom:1px solid var(--border);
  padding:10px;
  overflow-x:auto;
}
nav button{
  border:none;
  background:none;
  padding:10px 16px;
  font-weight:600;
  cursor:pointer;
  border-bottom:3px solid transparent;
}
nav button.active{
  border-color:var(--red);
  color:var(--red);
}
main{padding:20px}
.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:12px;
  padding:20px;
  margin-bottom:20px;
}
.card h2{margin-bottom:14px}
label{font-size:13px;font-weight:600}
input,select{
  width:100%;
  padding:10px;
  margin-top:6px;
  margin-bottom:14px;
  border:1px solid var(--border);
  border-radius:8px;
}
button.primary{
  background:var(--red);
  color:#fff;
  border:none;
  padding:10px 18px;
  border-radius:8px;
  font-weight:600;
  cursor:pointer;
}
table{
  width:100%;
  border-collapse:collapse;
}
th,td{
  border-bottom:1px solid var(--border);
  padding:10px;
  text-align:left;
  font-size:14px;
}
th{background:#f3f4f6}
.success{color:green;font-weight:600}
.error{color:#b91c1c;font-weight:600}
</style>
</head>

<body>
<header>
  <div class="logo"><span>ERP</span> Enhanced</div>
  <div id="tgUser"></div>
</header>

<nav>
  <button onclick="setTab('dashboard')" class="active">üìä Dashboard</button>
  <button onclick="setTab('sales')">üí∞ –ü—Ä–æ–¥–∞–∂–∏</button>
  <button onclick="setTab('receipts')">üì• –ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è</button>
  <button onclick="setTab('clients')">üë• –ö–ª–∏–µ–Ω—Ç—ã</button>
  <button onclick="setTab('products')">üì¶ –¢–æ–≤–∞—Ä—ã</button>
  <button onclick="setTab('prices')">üíµ –¶–µ–Ω—ã</button>
</nav>

<main id="app"></main>

<script>
// ================= –ù–ê–°–¢–†–û–ô–ö–ê =================
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzY6j5lqgw5SIgfZtl0el4fnI1B2pRuBCrdA-Gp5PnSZVkC43pvlPv9XPEMF5-iwBQeLA/exec";
// ============================================

const tg = window.Telegram?.WebApp;
const tgUser = tg?.initDataUnsafe?.user;
if(tg){ tg.ready(); tg.expand(); }
document.getElementById("tgUser").innerText =
  tgUser ? `üë§ ${tgUser.first_name}` : "Web";

// ========= STATE =========
let state={
  tab:"dashboard",
  clients:[],
  products:[],
  clientProducts:[],
  selectedClient:null
};

// ========= API =========
async function api(action, params={}){
  const url=new URL(SCRIPT_URL);
  url.searchParams.set("action",action);
  Object.entries(params).forEach(([k,v])=>url.searchParams.set(k,v));
  const r=await fetch(url);
  return r.json();
}

// ========= INIT =========
async function init(){
  state.clients=(await api("getClients")).clients||[];
  state.products=(await api("getProducts")).products||[];
  render();
}
init();

// ========= UI =========
function setTab(t){
  state.tab=t;
  document.querySelectorAll("nav button").forEach(b=>b.classList.remove("active"));
  event.target.classList.add("active");
  render();
}

function render(){
  const app=document.getElementById("app");
  if(state.tab==="dashboard"){
    app.innerHTML=`
      <div class="card">
        <h2>üìä Dashboard</h2>
        <p>–ö–ª–∏–µ–Ω—Ç–æ–≤: <b>${state.clients.length}</b></p>
        <p>–¢–æ–≤–∞—Ä–æ–≤: <b>${state.products.length}</b></p>
      </div>`;
  }

  if(state.tab==="clients"){
    app.innerHTML=`
      <div class="card">
        <h2>üë• –ö–ª–∏–µ–Ω—Ç—ã</h2>
        <table>
          <tr><th>ID</th><th>–ò–º—è</th><th>chat_id</th></tr>
          ${state.clients.map(c=>`
            <tr>
              <td>${c.id}</td>
              <td>${c.name}</td>
              <td>${c.chat_id}</td>
            </tr>`).join("")}
        </table>
      </div>`;
  }

  if(state.tab==="products"){
    app.innerHTML=`
      <div class="card">
        <h2>üì¶ –¢–æ–≤–∞—Ä—ã</h2>
        <table>
          <tr><th>ID</th><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–ï–¥.</th></tr>
          ${state.products.map(p=>`
            <tr>
              <td>${p.id}</td>
              <td>${p.name}</td>
              <td>${p.unit}</td>
            </tr>`).join("")}
        </table>
      </div>`;
  }

  if(state.tab==="prices"){
    app.innerHTML=`
      <div class="card">
        <h2>üíµ –¶–µ–Ω—ã –∫–ª–∏–µ–Ω—Ç–∞</h2>
        <label>–ö–ª–∏–µ–Ω—Ç</label>
        <select onchange="loadClientPrices(this.value)">
          <option value="">-- –≤—ã–±—Ä–∞—Ç—å --</option>
          ${state.clients.map(c=>`<option value="${c.id}">${c.name}</option>`)}
        </select>
        <div id="pricesTable"></div>
      </div>`;
  }

  if(state.tab==="sales"){
    app.innerHTML=`
      <div class="card">
        <h2>üí∞ –ü—Ä–æ–¥–∞–∂–∞</h2>
        <label>–ö–ª–∏–µ–Ω—Ç</label>
        <select onchange="selectClient(this.value)">
          <option value="">-- –≤—ã–±—Ä–∞—Ç—å --</option>
          ${state.clients.map(c=>`<option value="${c.id}">${c.name}</option>`)}
        </select>
        <label>–¢–æ–≤–∞—Ä</label>
        <select id="saleProduct"></select>
        <label>–ö–æ–ª-–≤–æ</label>
        <input id="qty" type="number" value="1" oninput="calcSum()"/>
        <label>–¶–µ–Ω–∞</label>
        <input id="price" readonly/>
        <label>–°—É–º–º–∞</label>
        <input id="sum" readonly/>
        <button class="primary" onclick="saveSale()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>`;
  }

  if(state.tab==="receipts"){
    app.innerHTML=`
      <div class="card">
        <h2>üì• –ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ</h2>
        <label>–ö–ª–∏–µ–Ω—Ç</label>
        <select id="rcClient">
          ${state.clients.map(c=>`<option value="${c.id}">${c.name}</option>`)}
        </select>
        <label>–°—É–º–º–∞</label>
        <input id="rcSum" type="number"/>
        <button class="primary" onclick="saveReceipt()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>`;
  }
}

// ========= LOGIC =========
async function loadClientPrices(id){
  state.clientProducts=(await api("getClientProducts",{clientId:id})).products||[];
  document.getElementById("pricesTable").innerHTML=`
    <table>
      <tr><th>–¢–æ–≤–∞—Ä</th><th>–¶–µ–Ω–∞</th></tr>
      ${state.clientProducts.map(p=>`
        <tr><td>${p.product_name}</td><td>${p.price}</td></tr>`).join("")}
    </table>`;
}

async function selectClient(id){
  state.selectedClient=id;
  const r=await api("getClientProducts",{clientId:id});
  state.clientProducts=r.products||[];
  document.getElementById("saleProduct").innerHTML=
    state.clientProducts.map(p=>
      `<option value="${p.product_id}" data-price="${p.price}">${p.product_name}</option>`
    ).join("");
  calcSum();
}

function calcSum(){
  const p=document.querySelector("#saleProduct option:checked");
  if(!p)return;
  const price=p.dataset.price;
  const qty=document.getElementById("qty").value;
  document.getElementById("price").value=price;
  document.getElementById("sum").value=price*qty;
}

async function saveSale(){
  const p=document.querySelector("#saleProduct option:checked");
  await api("addSale",{
    clientId:state.selectedClient,
    productId:p.value,
    quantity:document.getElementById("qty").value
  });
  alert("–ü—Ä–æ–¥–∞–∂–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞");
}

async function saveReceipt(){
  await api("addReceipt",{
    clientId:document.getElementById("rcClient").value,
    amount:document.getElementById("rcSum").value
  });
  alert("–ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ");
}
</script>
</body>
</html>
